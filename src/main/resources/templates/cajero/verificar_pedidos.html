<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Verificar Pedidos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body class="d-flex vh-100 overflow-hidden">
<div class="d-flex flex-column p-3 bg-white border-end" style="width: 250px;">
    <h4><i class="bi bi-person-badge"></i> Cajero</h4>
    <hr>
    <ul class="nav nav-pills flex-column mb-auto">
        <li><a href="/cajero" class="nav-link text-dark"><i class="bi bi-house"></i> Inicio</a></li>
        <li><a href="/cajero/verificar" class="nav-link active bg-light text-dark fw-bold"><i class="bi bi-check2-circle"></i> Verificar</a></li>
    </ul>
    <hr>
    <a href="/logout" class="nav-link text-danger"><i class="bi bi-box-arrow-left"></i> Salir</a>
</div>

<div class="flex-grow-1 bg-light overflow-auto">
    <header class="bg-white border-bottom p-3"><i class="bi bi-person-circle"></i> <b>Cajero</b></header>
    <div class="container mt-4" style="max-width: 800px;">

        <div class="mb-5">
            <table class="table table-bordered border-dark text-center">
                <thead class="table-secondary">
                <tr><th>N°</th><th>Mesa / Cliente</th><th>Fecha</th><th>Estado</th><th>Detalle</th></tr>
                </thead>
                <tbody>
                <tr th:each="p : ${pedidos}">
                    <td th:text="${p.id}"></td>
                    <td class="fw-bold text-primary" th:text="${p.cliente.nombre}"></td>
                    <td th:text="${p.fechaEmision}"></td>
                    <td><span class="badge bg-warning text-dark">Pendiente</span></td>
                    <td><button class="btn btn-link fw-bold" th:onclick="'cargar(' + ${p.id} + ')'"><i class="bi bi-search"></i> Ver</button></td>
                </tr>
                <tr th:if="${#lists.isEmpty(pedidos)}"><td colspan="5" class="text-muted">No hay pedidos pendientes.</td></tr>
                </tbody>
            </table>
        </div>

        <div id="detalle" style="display:none; text-align:center;">
            <h2 class="text-muted mb-4" style="font-family: serif;">Detalle del Pedido</h2>
            <table class="table table-bordered border-dark w-75 mx-auto mb-4">
                <thead class="table-secondary"><tr><th>Producto</th><th>Cant.</th><th>Stock Actual</th></tr></thead>
                <tbody id="tablaDetalle"></tbody>
            </table>

            <div class="d-flex justify-content-center gap-3">
                <a id="btnValidar" href="#" class="btn btn-outline-success px-4 py-2 fw-bold">
                    <i class="bi bi-check-lg"></i> Validar Pago
                </a>

                <a id="btnCancelar" href="#" class="btn btn-outline-danger px-4 py-2 fw-bold"
                   onclick="return confirm('¿Está seguro de CANCELAR este pedido? La mesa quedará libre automáticamente.')">
                    <i class="bi bi-x-lg"></i> Cancelar Pedido
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-success text-white"><h5>Validado</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center p-4">Pedido validado correctamente.</div><div class="modal-footer"><button class="btn btn-success" data-bs-dismiss="modal">OK</button></div></div></div></div>

<div class="modal fade" id="modalCan" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5>Cancelado</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center p-4">El pedido ha sido cancelado y la mesa está LIBRE nuevamente.</div><div class="modal-footer"><button class="btn btn-danger" data-bs-dismiss="modal">OK</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Mostrar modales según URL
    const params = new URLSearchParams(window.location.search);
    if(params.has('validado')) new bootstrap.Modal(document.getElementById('modalVal')).show();
    if(params.has('cancelado')) new bootstrap.Modal(document.getElementById('modalCan')).show();

    // Cargar detalle con AJAX
    function cargar(id) {
        fetch('/cajero/api/detalle/' + id).then(r => r.json()).then(data => {
            let html = '';
            data.forEach(i => html += `<tr><td>${i.nombreProducto}</td><td>${i.cantidad}</td><td class="text-success fw-bold">${i.stock}</td></tr>`);
            document.getElementById('tablaDetalle').innerHTML = html;

            // Actualizamos los enlaces de los botones con el ID correcto
            document.getElementById('btnValidar').href = '/cajero/validar/' + id;
            document.getElementById('btnCancelar').href = '/cajero/cancelar/' + id;

            document.getElementById('detalle').style.display = 'block';
        });
    }
</script>
</body>
</html>